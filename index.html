<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Website Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --panel:#141c2f; --text:#e6eefc; --muted:#9db0d3; --accent:#10bfa0; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:2rem;max-width:1100px;color:var(--text);background:var(--bg)}
    h1{margin:0 0 1.2rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem}
    textarea{width:100%;min-height:140px;padding:1rem;font-size:1rem;background:var(--panel);border:1px solid #24304a;color:var(--text);border-radius:12px}
    button{padding:.75rem 1rem;font-size:1rem;cursor:pointer;border:none;border-radius:10px}
    .row{display:flex;gap:.6rem;align-items:center;margin:.7rem 0 1.1rem;flex-wrap:wrap}
    .presets{display:flex;gap:.5rem;flex-wrap:wrap}
    .preset{border:1px solid #2b395a;background:var(--panel);color:var(--text)}
    .preset:hover{filter:brightness(1.1)}
    .go{background:var(--accent);color:#02110c;font-weight:600}
    .zip{background:#22c55e;color:#02110c;font-weight:600}
    iframe{width:100%;height:540px;border:1px solid #2b395a;border-radius:12px;background:#fff}
    pre{background:#0a0f1a;color:#d9e5ff;padding:1rem;border-radius:12px;white-space:pre-wrap;max-height:28rem;overflow:auto;border:1px solid #1a2440}
    .tabs{display:flex;gap:.5rem;margin:.5rem 0}
    .tabs button{border:1px solid #2b395a;background:var(--panel);color:var(--text)}
    .code{display:none}
    .code.active{display:block}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <h1>ðŸ§ª Website Generator</h1>

  <div class="grid">
    <div>
      <label for="spec"><b>Describe the site you want:</b></label>
      <textarea id="spec" placeholder="Example: A SaaS landing page with a hero, features grid, pricing, and a footer. Use a blue/purple gradient."></textarea>

      <!-- Presets for quick testing -->
      <div class="presets">
        <button class="preset" data-prompt="SaaS landing page for â€˜FocusFlowâ€™. Hero with headline + two CTAs, 3-feature grid with icons, testimonial card, pricing (Free/Pro), minimal footer. Blueâ†’purple gradient. Mobile-first.">SaaS</button>
        <button class="preset" data-prompt="Personal portfolio for web developer Kenny. Sticky nav (Home, Projects, About, Contact), hero with name + tagline, 6-card projects grid, skills badges (JS/Node/React), contact form. Neutral light theme, subtle shadows.">Portfolio</button>
        <button class="preset" data-prompt="Modern restaurant homepage for â€˜Ember & Thymeâ€™. Full-width hero with image overlay + reservation CTA, 3-column story/dishes/location, 4-card menu preview, footer with hours + socials. Warm palette, serif headings.">Restaurant</button>
        <button class="preset" data-prompt="Simple e-commerce grid (8 items) for â€˜GlowGearâ€™. Header with logo + cart counter, search input, 4-col product grid (image, name, price, Add to Cart), footer. Black/white high-contrast with neon accent. Add fake cart count in JS.">E-com</button>
      </div>

      <div class="row">
        <button id="gen" class="go">Generate</button>
        <button id="download" class="zip" disabled>Download .zip</button>
        <span class="muted" id="status"></span>
      </div>

      <div class="tabs">
        <button data-tab="html">HTML</button>
        <button data-tab="css">CSS</button>
        <button data-tab="js">JS</button>
      </div>
      <pre id="html" class="code"></pre>
      <pre id="css" class="code"></pre>
      <pre id="js" class="code"></pre>
    </div>

    <div>
      <b>Live Preview</b>
      <iframe id="preview" title="generated-site"></iframe>
    </div>
  </div>

  <script type="module">
    // --- helpers (WHY: prevent accidental closing of this script tag + support full-doc returns) ---
    const escClose = s => String(s ?? "").replace(/<\/script>/gi, '<\\/script>');
    function buildPreviewDoc({ html, css, js }) {
      const isFullDoc = /<!doctype|<html|<head|<body/i.test(html || "");
      if (isFullDoc) {
        // inject inline CSS before </head>, inline JS before </body>
        let out = html.replace(/<\/head>/i, `<style>${css ?? ""}</style></head>`);
        out = out.replace(/<\/body>/i, `<script>${escClose(js ?? "")}<\/script></body>`);
        return escClose(out);
      }
      // wrap a body fragment
      return escClose(`<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<style>${css ?? ""}</style>
</head>
<body>
${html ?? ""}
<script>${escClose(js ?? "")}<\/script>
</body>
</html>`);
    }

    // --- DOM refs ---
    const $ = (q) => document.querySelector(q);
    const spec = $("#spec");
    const btnGen = $("#gen");
    const btnZip = $("#download");
    const statusEl = $("#status");
    const frame = $("#preview");
    const htmlBox = $("#html");
    const cssBox = $("#css");
    const jsBox  = $("#js");

    // Tabs
    document.querySelectorAll(".tabs button").forEach(b=>{
      b.onclick = ()=>{
        document.querySelectorAll(".code").forEach(c=>c.classList.remove("active"));
        $("#"+b.dataset.tab).classList.add("active");
      };
    });
    htmlBox.classList.add("active");

    // Presets
    document.querySelectorAll(".preset").forEach(p=>{
      p.onclick = ()=>{ spec.value = p.dataset.prompt; spec.focus(); };
    });

    // Generate
    btnGen.onclick = async () => {
      btnGen.disabled = true; btnZip.disabled = true;
      statusEl.textContent = "Generatingâ€¦";
      try {
        const res = await fetch("http://localhost:3000/generate", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt: spec.value || "A simple portfolio with hero, projects grid, and contact form." })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        const data = await res.json();

        const current = {
          html: data.html ?? "",
          css:  data.css  ?? "",
          js:   data.js   ?? ""
        };

        // Show code
        htmlBox.textContent = current.html;
        cssBox.textContent  = current.css;
        jsBox.textContent   = current.js;

        // Build and load preview
        const doc = buildPreviewDoc(current);
        frame.srcdoc = doc;

        btnZip.disabled = false;
        statusEl.textContent = "Done.";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed: " + e.message;
        alert("Generation failed: " + e.message);
      } finally {
        btnGen.disabled = false;
      }
    };

    // Download .zip (index.html / style.css / script.js)
    btnZip.onclick = async () => {
      const files = {
        "index.html": escClose(`<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<title>Generated Site</title>
</head>
<body>
${htmlBox.textContent}
<script src="script.js"><\/script>
</body>
</html>`),
        "style.css": cssBox.textContent,
        "script.js": jsBox.textContent
      };

      const enc = new TextEncoder();
      const entries = [];
      let offset = 0;
      const parts = [];

      const crc32 = (str) => {
        let c = ~0 >>> 0;
        for (let i = 0; i < str.length; i++){
          c = (c ^ str.charCodeAt(i)) >>> 0;
          for (let k = 0; k < 8; k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
        }
        return (~c) >>> 0;
      };

      // local headers + data
      for (const [name, content] of Object.entries(files)) {
        const bytes = enc.encode(content);
        const nameBytes = enc.encode(name);
        const crc = crc32(content);

        const local = new Uint8Array(30 + nameBytes.length);
        const dv = new DataView(local.buffer);
        dv.setUint32(0, 0x04034b50, true);
        dv.setUint16(4, 20, true);
        dv.setUint16(6, 0, true);
        dv.setUint16(8, 0, true); // store
        dv.setUint16(10, 0, true);
        dv.setUint16(12, 0, true);
        dv.setUint32(14, crc, true);
        dv.setUint32(18, bytes.length, true);
        dv.setUint32(22, bytes.length, true);
        dv.setUint16(26, nameBytes.length, true);
        dv.setUint16(28, 0, true);
        local.set(nameBytes, 30);

        parts.push(local, bytes);
        entries.push({ nameBytes, crc, size: bytes.length, offset });
        offset += local.length + bytes.length;
      }

      // central directory
      const centrals = [];
      let centralSize = 0;
      for (const e of entries) {
        const header = new Uint8Array(46 + e.nameBytes.length);
        const dv = new DataView(header.buffer);
        dv.setUint32(0, 0x02014b50, true);
        dv.setUint16(4, 20, true);
        dv.setUint16(6, 20, true);
        dv.setUint16(8, 0, true);
        dv.setUint16(10, 0, true);
        dv.setUint16(12, 0, true);
        dv.setUint32(16, e.crc, true);
        dv.setUint32(20, e.size, true);
        dv.setUint32(24, e.size, true);
        dv.setUint16(28, e.nameBytes.length, true);
        dv.setUint16(30, 0, true);
        dv.setUint16(32, 0, true);
        dv.setUint16(34, 0, true);
        dv.setUint16(36, 0, true);
        dv.setUint32(38, 0, true);
        dv.setUint32(42, e.offset, true);
        header.set(e.nameBytes, 46);

        centrals.push(header);
        centralSize += header.length;
      }

      // end of central directory
      const end = new Uint8Array(22);
      const dvEnd = new DataView(end.buffer);
      dvEnd.setUint32(0, 0x06054b50, true);
      dvEnd.setUint16(4, 0, true);
      dvEnd.setUint16(6, 0, true);
      dvEnd.setUint16(8, entries.length, true);
      dvEnd.setUint16(10, entries.length, true);
      dvEnd.setUint32(12, centralSize, true);
      dvEnd.setUint32(16, offset, true);
      dvEnd.setUint16(20, 0, true);

      const blob = new Blob([...parts, ...centrals, end], { type: "application/zip" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "generated-site.zip";
      a.click();
      URL.revokeObjectURL(a.href);
    };
  </script>
</body>
</html>
